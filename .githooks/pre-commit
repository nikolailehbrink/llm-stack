#!/bin/sh
# Pre-commit: auto-format staged files, then run lint and knip checks

# Get staged formattable files (added, copied, modified, renamed)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.json' '*.css')

if [ -n "$STAGED_FILES" ]; then
  echo "Formatting staged files..."
  echo "$STAGED_FILES" | xargs npm run fmt

  # Re-stage the formatted files
  echo "$STAGED_FILES" | xargs git add
fi

echo "Running linter..."
npm run lint || {
  echo "Lint errors found. Run 'npm run lint:fix' to fix."
  exit 1
}

echo "Running knip..."
npm run knip || {
  echo "Unused code detected. Run 'npm run knip' for details."
  exit 1
}
